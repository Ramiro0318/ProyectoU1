<!DOCTYPE html>
<html lang="en">
<head>
    <style>


    </style>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="Estilo.css" rel="stylesheet">
    <title>Lista de alumnos</title>
</head>
<body>

    <h1>Registro de calificaciones</h1>
    
    <span>

        <span class="promedio">
            <label>Promedio:</label>
            <label class="invisivle">_</label>
            <label id = promedio></label>
        </span>
        
        <form>
            <table class="tablaInput">
                <thead>
                    <th>No.</th>
                    <th>Numero de control</th>
                    <th>Nombre completo</th>
                    <th>Calificacion</th>   
                    <th>Aprobación</th>                         
                </thead>
                <tbody id ="tablaAgregar">
                </tbody>
            </table>
            <label id = error class="error">soy invisible</label>
        </form>
    </span>
    <div id="accionesGlobales" class="acciones">
        <button id="btnEditar">Editar</button>
        <button id="btnEliminar">Eliminar</button>
    </div>
    <table>
        <thead>
            <th>No.</th>
            <th>Numero de control</th>
            <th>Nombre completo</th>
            <th>Calificacion</th>   
            <th>Aprobación</th>                         
        </thead>
        <tbody id="tablaAlumnos"></tbody>
    </table>  
   

    
    <script>
        const tableAlumnos = document.getElementById("tablaAlumnos");
        const tableAgregar = document.getElementById("tablaAgregar");
        const form = document.querySelector("form");
        const btnEditar = document.getElementById("btnEditar");
        const btnEliminar = document.getElementById("btnEliminar");
        const acciones = document.getElementById("accionesGlobales");
        const lblError = document.getElementById("error");
        let promedio = document.getElementById("promedio");
        let cell = document.createElement("td");
        let filaSeleccionada = null;
        let datosSeleccionados = null;
        let datosAEditar = null;
        let enTransaccion = false;
        

        const datos = [
        ["221G0278","ALVAREZ FARÍAS ADRIÁN","71"],
        ["221G0280","ALVAREZ MONTALVO CARLOS ANTONIO","69"],
        ["171G0463","DE LEON JUÁREZ CRISTIAN DANIEL","69"],
        ["221G0290","ESCAREÑO CALZONCIT DAVID","68"],
        ["221G0296","GARCÍA LEAL CARLOS EMILIANO","84"],
        ["221G0299","GOMEZ SANCHEZ NOE MISSAEL","90"],
        ["221G0300","GONZALEZ ARANDA ERICK","50"],
        ["221G0298","GÓMEZ BACA CRISTIAN ALEJANDRO","16"],
        ["221G0304","LUGO SALAZAR BRANDON OZIEL","32"],
        ["221G0158","MATA VILLA ALFREDO HARAN","100"],
        ["211G0366","MEJÍA CHAVANA JESÚS FEDERICO","46"],
        ["221G0308","NAJERA PEREZ DAGOBERTO","55"],
        ["221G0310","PADILLA RAMOS EVELYN NOEMI","70"],
        ["221G0314","PUENTE ENRIQUEZ JOSE HUMBERTO","63"],
        ["201G0279","REYES MENDOZA JULIO CESAR","75"],
        ["221G0316","REYES MENDOZA KEVIN GAEL","40"],
        ["221G0321","RODRÍGUEZ VALVERDE RAMIRO RONALDO","83"],
        ["221G0326","SAUCEDO DE LA CRUZ DANIEL ALEJANDRO","81"],
        ["211G0392","TORRES RIOS CECILIA ESMERALDA","42"],
        ["221G0330","VELAZQUEZ ESPINOZA TAMARA AZCENETH","60"],
        ["221G0333","ZAPATA VARGAS DANIEL","0"]
        ];


        function CrearFilasConInputs(datos) {
            let row = document.createElement("tr");
            
            let inputNumeroControl = document.createElement('input');
            inputNumeroControl.id = "inputNumeroControl";
            inputNumeroControl.type = "text";
            inputNumeroControl.required = true;
            
            let inputNombre = document.createElement("input");
            inputNombre.id = "inputNombre";
            inputNombre.required = true;
            let inputCalificacion = document.createElement('input');
            inputCalificacion.id = "inputCalificacion";
            inputCalificacion.type = "number";
            inputCalificacion.min = 0;
            inputCalificacion.max = 100;
            let inputAprobacion = document.createElement('input');
            inputAprobacion.id = "inputAprobacion";
            inputAprobacion.type = "submit";
            inputAprobacion.value = "Agregar"
            
            
            
            let inputCells = [inputNumeroControl, inputNombre, inputCalificacion, inputAprobacion ];
            
            
            
            if (datos != null) {
                inputAprobacion.type = "text";
                inputAprobacion.readOnly = true;
                tableAlumnos.replaceChild(row,filaSeleccionada);
                filaSeleccionada = row;
                filaSeleccionada.classList.add("seleccionada");
                

                for (let d = 0; d < datos.length; d++) {
                    inputCells[d].value = datos[d];
                }
                
            }
            else {
                
                tableAgregar.appendChild(row);
            }
                
                for (let index = 0; index < 5; index++) {
                    let cell = document.createElement("td");
                    
                    
                    if (index == 0) { cell.textContent = `${row.rowIndex} .-`; }
                    else{
                        
                        cell.appendChild(inputCells[index - 1]);
                    }
                    row.appendChild(cell);
                    
                }

            return filaSeleccionada;
                
             
            
        }
        
        CrearFilasConInputs(); 

        function Validar(alumno){
            const regNum = /\d{2}1[ADMTGPQVI][0CEML]\d{3}/;
            lblError.classList.remove("invisivle");
            
            if (alumno[0] == undefined || alumno[1] == undefined || alumno[2] == undefined ) 
            {
                console.log("Datos faltantes");
                
                return false
            }
            else if(!regNum.test(alumno[0]))
            {
                console.log("Numero de control no cumple con las condiciones");
                lblError.textContent = "Numero de control no cumple con las condiciones";
                return false;
            }
            else if (tableAlumnos.rows.length > 0)
            {
                for(let i = 0; i < tableAlumnos.rows.length; i++)
                {
                    if (alumno[0] == tableAlumnos.rows[i].cells[1].textContent) {
                        console.log("Numero de control repetido"); 
                        lblError.textContent = "Numero de control repetido";
                        return false;   
                    }
                    else if (alumno[1].trim().toLowerCase() === tableAlumnos.rows[i].cells[2].textContent.trim().toLowerCase()) {
                        console.log("Nombre repetido");
                        lblError.textContent = "Nombre repetido";
                        return false;   
                    }
                    else if (alumno[2] > 100 || alumno[2] < 0) { 
                        console.log("Calificacion no valida");
                        lblError.textContent = "Calificacion no valida"; //Nunca se va a mostrar
                        return false;
                    }
                }
                return true;
            }
            else return true;
    
        }


        function CrearNuevoAlumno(alumno)
        {
            let newRow = document.createElement("tr");
            tableAlumnos.appendChild(newRow);
            for (let index = 0; index < 5; index++) { //usar un .length
                
                let newtd = document.createElement("td");
                if (index == 0) { newtd.textContent = `${newRow.rowIndex}.-`; }
                else 
                {
                    newtd.textContent = alumno[index-1];
                }
                newRow.appendChild(newtd);
                
            }
            newRow.cells[4].textContent = alumno[2] >= 70 ? "Aprobado" : "Reprobado";
            if (newRow.cells[4].textContent === "Aprobado" )
            {
                newRow.cells[4].classList.add("aprobado");
            }
            else if (newRow.cells[4].textContent === "Reprobado") { newRow.cells[4].classList.add("reprobado"); }
            
            CalcularPromedio();
            lblError.classList.add("invisivle");
            // let total = 0;
            // for (let index = 0; index < tableAlumnos.rows.length; index++) {
                
            //     total += parseFloat(tableAlumnos.rows[index].cells[3].textContent);
            // }
            // promedio.textContent = Math.round((total / tableAlumnos.rows.length) * 100) / 100;
        }

        function EditarAlumno(alumno)
        {
            if( Validar(alumno))
            {
                let row = document.createElement("tr");
                
                for (let index = 0; index < 5; index++) {
                
                    let newtd = document.createElement("td");
                    if (index == 0) { newtd.textContent = `${filaSeleccionada.textContent}`; }
                    else if (index < 4 )
                    {
                        newtd.textContent = alumno[index-1];
                    }
                    else {
                        newtd.textContent = alumno[2] >= 70 ? "Aprobado" : "Reprobado";
                        
                        
                    }
                    row.appendChild(newtd);
                    if (newtd.textContent === "Aprobado" )
                    {
                        newtd.classList.add("aprobado");
                    }
                    else if (newtd.textContent === "Reprobado") { newtd.classList.add("reprobado"); }

                }

                tableAlumnos.replaceChild(row,filaSeleccionada);
                CalcularPromedio();
                btnEditar.textContent = "Editar";
                btnEliminar.textContent = "Eliminar";
                lblError.classList.add("invisivle");
            }
        }
        function CalcularPromedio()
        {
            let total = 0;
            for (let index = 0; index < tableAlumnos.rows.length; index++) {
                
                total += parseFloat(tableAlumnos.rows[index].cells[3].textContent);
            }
            promedio.textContent = Math.round((total / tableAlumnos.rows.length) * 100) / 100;
        }
    
      
            datos.forEach(alumno => {
                if(Validar(alumno)){CrearNuevoAlumno(alumno);}
            });

            form.addEventListener("submit", function(){
                if (enTransaccion){return}
                event.preventDefault();
            
           
                let NumeroControl = document.getElementById("inputNumeroControl").value.trim().toUpperCase();
                let Nombre = document.getElementById("inputNombre").value;
                let Calificacion = document.getElementById("inputCalificacion").value;
                //let Aprobacion ; 

                let NuevoAlumno = [NumeroControl, Nombre, Calificacion]
                
                if (Validar(NuevoAlumno))
                {
                    CrearNuevoAlumno(NuevoAlumno);
                }
        });

        
        tableAlumnos.addEventListener("dblclick", function(e) {
            if (enTransaccion){return}
            if(filaSeleccionada){
                                                      
                clonFila = filaSeleccionada.cloneNode(true);
                datosSeleccionados = Array.from(filaSeleccionada.cells).map(function(td)
                {return td.textContent.trim();}).slice(1);
                filaSeleccionada = CrearFilasConInputs(datosSeleccionados);

                btnEditar.textContent = "Aceptar";
                btnEliminar.textContent = "Cancelar";
                
            } else {

                filaSeleccionada = null;
                return;
            }
            enTransaccion = true;
  
        });

        tableAlumnos.addEventListener("pointerdown", function(e) {
            if (enTransaccion){return}
            let fila = e.target.closest("tr");
                                                //optimizar eliminando fila
            if (!fila || !tableAlumnos.contains(fila)) return;
            
            Array.from(tableAlumnos.rows).forEach(r => r.classList.remove("seleccionada"));
            
            
            fila.classList.add("seleccionada");
            acciones.classList.add("visible");
            filaSeleccionada = fila; //Cambi[e fila seleccionada por row y row por fila seleccionada
            fila = null;
        });
        
        document.addEventListener("pointerdown", function(e) {
            if(!tableAlumnos.contains(e.target) && (!acciones || !acciones.contains(e.target)))
                                                    //!document.getElementById("accionesGlobales")) 
            {
                acciones.classList.remove("visible");
                Array.from(tableAlumnos.rows).forEach(r => r.classList.remove("seleccionada"));
                if (clonFila != null){

                    tableAlumnos.replaceChild(clonFila,filaSeleccionada);
                    filaSeleccionada = null;
                    clonFila = null;
                    enTransaccion = false;
                    btnEditar.textContent = "Editar";
                    btnEliminar.textContent = "Eliminar";
                } 
            }

        });

        let clonFila = null; 
        // Botones
        btnEditar.onclick = function() {
            if(this.textContent == "Aceptar") {
                
                datosAEditar = Array.from(filaSeleccionada.cells).slice(1, -1)
                .map(function(td) {return td.firstElementChild.value.trim();})
                
                EditarAlumno(datosAEditar);
                acciones.classList.remove("visible");
                enTransaccion = false;
            
            }
            else{

                if (filaSeleccionada) {
                    
                    clonFila = filaSeleccionada.cloneNode(true);
                    datosSeleccionados = Array.from(filaSeleccionada.cells).map(function(td)
                    {return td.textContent.trim();}).slice(1);
                    filaSeleccionada = CrearFilasConInputs(datosSeleccionados);

                    btnEditar.textContent = "Aceptar";
                    btnEliminar.textContent = "Cancelar";
                    
                } else {

                    filaSeleccionada = null;
                    return;
                }
                enTransaccion = true;
            }
        };

        btnEliminar.onclick = function() {
            if(this.textContent == "Cancelar")
            {

                tableAlumnos.replaceChild(clonFila,filaSeleccionada);
                filaSeleccionada = null;
                clonFila = null;
                acciones.classList.remove("visible");
                Array.from(tableAlumnos.rows).forEach(r => r.classList.remove("seleccionada"));
                btnEditar.textContent = "Editar";
                btnEliminar.textContent = "Eliminar";
                enTransaccion = false;
            }
            else {

                if (filaSeleccionada) {
                    tableAlumnos.removeChild(filaSeleccionada);
                    CalcularPromedio();
                    acciones.classList.remove("visible");
                    filaSeleccionada = null;
                } else {
                    console.log("Primero selecciona una fila");
                    lblError.textContent = "Primero selecciona una fila";
                }
            }
        };




    </script>
</body>
</html>